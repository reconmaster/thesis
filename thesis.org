#+TITLE:
#+DATE:
#+AUTHOR:
#+EMAIL:
#+OPTIONS: ':nil *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline
#+OPTIONS: author:t c:nil creator:nil d:(not "LOGBOOK") date:nil e:t
#+OPTIONS: email:nil f:t inline:t num:t p:nil pri:nil prop:nil stat:t
#+OPTIONS: tags:t tasks:t tex:t timestamp:t title:t toc:nil todo:t |:t
#+LANGUAGE: en
#+SELECT_TAGS: export
#+EXCLUDE_TAGS: noexport
#+LATEX_CLASS:thesis

# for tikz figures
# +LATEX_HEADER: \usepackage{tikz}
# +LATEX_HEADER: \usetikzlibrary{positioning}

#+BEGIN_EXPORT latex
%% Use these commands to set biographic information for the title page:
\title{Enabling Novel IGRT Imaging Trajectories with Optimization-Based Reconstruction Algorithms}
\author{Andrew Davis}
\department{Committee on Medical Physics}
\division{Biological Sciences}
\degree{Ph. D.}
\date{August, 2017}

%% Use these commands to set a dedication and epigraph text
\dedication{Dedication Text}
\epigraph{Epigraph Text}

% If you don't want a title page comment out the next line and uncomment the line after it:
\maketitle
%\omittitle

% These lines can be commented out to disable the copyright/dedication/epigraph pages
\makecopyright
\makededication
\makeepigraph

%% Make the various tables of contents
\tableofcontents
\listoffigures
\listoftables

\acknowledgments
% Enter Acknowledgements here

\abstract
% Enter Abstract here

\mainmatter
% Main body of text follows
#+END_EXPORT

* notes                                      :noexport:
  :PROPERTIES:
  :ID:       7f3d97de-795e-402a-82ac-591717f86bfd
  :END:
** requirements
   :PROPERTIES:
   :ID:       931c9c50-bfaf-4c8e-b2cc-bcfdf62e327d
   :END:

- [[http://www.lib.uchicago.edu/e/phd/][uchicago]] dissertation guide
- [[https://github.com/zuwiki/ucetd-latex][uoc thesis]] template

* Introduction
  :PROPERTIES:
  :ID:       852796c3-9a3b-49da-bc08-1299e93e0768
  :END:
*RE-WRITE INTRODUCTION?*

# Derived from the Ancient Greek words τόμος or /tomos/ meaning "slice"
# and γράφω or /grapho/ meaning "to write", tomography is the technique
# of using penetrating wave to create an image of a slice in an object
# while either blurring or obscuring details from other planes in the
# object. The ability to peer inside an object and create a map of its
# contents is a powerful tool that is routinely used in myriad
# applications. Today, tomographic methods can be found being deployed
# in locations ranging from border-control checkpoints to local medical
# clinics.

As the non-invasive nature of tomographic imaging had obvious benefits
for the field of medicine, a lot of significant advances in
tomographic technology were driven by clinical research. One such form
of tomographic imaging is computed tomography (CT) which uses
projection images acquired from different locations around the object
to compute the distribution of material densities inside the object.
Though the mathematical framework for solving this inverse problem had
been formulated by Johann Radon in 1917 and a patent for what is
essentially CT was filled in 1940 by Gabriel Frank, it was not until
1967 that the work of Allan M. Cormack and Godfrey N. Hounsfield led
to the first clinical CT scanner. For their work, Cormack and
Housfield shared the 1979 Nobel Prize in Physiology and Medicine
cite:hsieh_computed_2009.

*MAYBE SCHEMATIC OR DIAGRAM*

In a CT scanner system, an x-ray source and opposing detector
typically rotate relative to the object being imaged as x-ray
projection images are acquired at different angular positions. Through
the years of CT research, a fundamental questions has always been how
to move the source and detector the imaging system relative to the
object to obtain sufficient projection information to reconstruction a
useful tomographic image. Part of this answer must take into account
certain engineering limitations that go into building such a system.
However, this is fundamentally a question that must address the
requirements of the computational reconstruction algorithm used to
assemble the image from the x-ray projections.

** Background: Computed Tomography
   :PROPERTIES:
   :ID:       898c8a79-a3b0-4cb2-b1be-2838c8b86426
   :END:
*** Analytic-Based Reconstruction
    :PROPERTIES:
    :ID:       20c14d08-7649-4644-b616-e86e0b7cc515
    :END:
In the 1980s, a lot of work was done to directly solve the inverse
problem for the cone-beam geometry. By modeling the projection
formation process as a Radon transform or an X-ray transform,
reconstruction algorithms were formulated by finding an analytic-based
inverse to the transform. However, for the inverse to be exact, it
needed to meet strict requirements such as Tuy's condition which
states that every plane through the object must intersect the source
trajectory cite:tuy_inversion_1983. While some exceptions to this
requirement were found, it demonstrates the strict requirements on the
types of scanning trajectories for which an exact inverse could be
found.

The circular scanning trajectory that is ubiquitous in the clinic for
CBCT is one trajectory that fails to meet Tuy's condition. The most
popular reconstruction algorithm for the circular CBCT trajectory is
the filtered-backprojection (FBP) algorithm proposed by Feldkamp,
Davis, and Kress (FDK) cite:feldkamp_practical_1984 which is still the
industry standard. FDK is only an exact inversion to the Radon
transform on the midplane containing the circular source
trajectory. For transaxial planes other than the midplane, a
quasi-redundancy in the scanning data is assumed. It is the violation
of this assumption which leads to cone-angle artifacts. These
artifacts become more severe at larger cone angles where this
assumption is less applicable.

The presence of cone-angle artifacts in FDK reconstructions from the
incomplete data acquired with circular scanning trajectories led to
research into inverse algorithms for cone-beam scans from
theoretically complete trajectories such as a circle plus a line
cite:zeng_cone-beam_1992. It became apparent in the reconstruction
results that implementing these direct reconstruction algorithms did
not produce the anticipated results cite:kudo_derivation_1994. Severe
artifacts and numerical errors were found in the reconstructions due
to factors such as truncation introducing high-frequency components
that are amplified in the filtration process.

*** Optimization-Based Reconstruction
    :PROPERTIES:
    :ID:       07e91084-61be-43d3-a905-65ef0ab997a4
    :END:
Analytic-based reconstruction algorithms are formulated by explicitly
finding an inverse to the X-ray transform
#+BEGIN_EXPORT latex
  \begin{equation}
    \label{eq:xray}
    g(\mathbf{r}_0,\hat{\theta})=\int_0^{\infty}f(\mathbf{r}_0+t\hat{\theta})dt,
  \end{equation}
#+END_EXPORT
where the data function $g$ is acquired by integrating along the ray
from the source at $\mathbf{r}_0$ in the direction $\hat{\theta}$ through
the object function $f$. A fundamental problem with these
reconstruction algorithms when practically reconstructing $f$ is the
assumption of a continuous-to-continuous (CC) model. These
analytic-based reconstruction algorithms impose dense sampling
requirements for both the detector and number of views to approximate
a continuous data function. Given that the data function from the
digital detector and the numerical array for storing the reconstructed
image are both discrete, a more natural approach to the inverse
problem would be a discrete-to-discrete (DD) imaging model
cite:barrett_foundations_2003.

Iterative reconstruction algorithms are more robust because they do
implement a more accurate DD model of the imaging system. The X-ray
transform of the object function can be represented as the linear
system
#+BEGIN_EXPORT latex
  \begin{equation}
    \label{eq:ddsys}
    \mathbf{g}=\mathcal{H}\mathbf{f},
  \end{equation}
#+END_EXPORT
where $\mathbf{g}$ is the discrete $M$ pixel sampled projection on the
detector, $\mathcal{H}$ is the $M\times N$ discrete form of the X-ray
transform, and $\mathbf{f}$ is the object function represented on a N
voxel basis. As direct inversion of $\mathcal{H}$ is impractical due
to both its size and inconsistencies from factors such as noise,
optimization techniques are used to solve this system for an estimate
of the object $\widetilde{\mathbf{f}}$.

The optimization problem for these iterative reconstruction algorithms
is formulated as an objective function based on the actual data
$\mathbf{g}$ and the image model $\mathcal{H}\mathbf{f}$. An
optimization algorithm is then used to iteratively update the estimate
of $\widetilde{\mathbf{f}}$ until a suitable convergence criterion has
been met. The parameters of the optimization problem, the optimization
algorithm, and the convergence criteria are all important factors in
determining the properties of the reconstructed image and subsequently
its utility.

Two optimization-based reconstruction methods we will use with these
non-circular trajectories are maximum-likelihood expectation
maximization (MLEM) cite:shepp_maximum_1982,dempster_maximum_1977 and
constrained, total-variation (TV) minimization by adaptive steepest
descent-projection onto convex sets (ASD-POCS)
cite:sidky_image_2008. Previous work has shown that these iterative
algorithms are able to reconstruct clinically useful images under
scanning conditions for which analytic-based FDK fails
cite:han_optimization-based_2012,sidky_image_2007,sidky_accurate_2006. The
reconstruction work from sparse-view data cite:bian_evaluation_2010
alone suggests that views could be distributed at different axial
positions to acquire additional scan information without imparting
more dose than the dense set of angular views used in current clinical
circular scans with analytic-based reconstruction.

** Background: Scanning Trajectories
   :PROPERTIES:
   :ID:       c90cd638-44e6-49f3-9283-29f75d163005
   :END:
*** Standard Trajectories
    :PROPERTIES:
    :ID:       6293da29-e448-4614-84b6-065af1cc6be9
    :END:
In IGRT, linac-mounted CBCT imaging systems such as Varian's OBI now
routinely provide patient image information. These images are used to
check the patient alignment before delivering the radiation
treatment. The circular rotation of the linac gantry defines the
acquisition trajectory for the CBCT scan. While such a scanning
trajectory provides sufficient information for an analytic-based
reconstruction of the scan volume, there are a variety of limitations
that arise from this work flow.

Due to engineering and cost restrictions, the OBI detector has a
limited size. This restricts the FOV that can be imaged in a
traditional circular scan. While the offset detector technique
cite:bian_optimization-based_2013,cho_cone-beam_1995 is commonly used
to increase the transaxial FOV, the axial coverage is still very
limited cite:pearson_non-circular_2010. The reason why the limited FOV
has not been addressed by increasing the detector size is partially
due to the industry reliance on the approximate FDK algorithm
cite:pan_why_2009. For increasingly large cone angles at the ends of
the axial FOV, the approximation in the algorithm becomes increasingly
worse resulting in cone-angle artifacts cite:feldkamp_practical_1984.

Another problem with the current circular imaging trajectory is
potential linac collisions with the patient
cite:hua_practical_2004,nioutsikou_patient-specific_2003. Cases arise
when the patient is positioned in the treatment position, a CBCT image
cannot be acquired due to part of the patient being in the path of the
linac's trajectory. As the current FDK algorithm requires a trajectory
with sufficient angular coverage, the patient must be moved to a
position where the gantry can make an uninterrupted rotation around
the patient.
* Optimization-based algorithms
  :PROPERTIES:
  :ID:       06ec01f2-e128-4baf-9ec7-4569a3aaa886
  :END:
** notes                                     :noexport:
   :PROPERTIES:
   :ID:       8ae68db5-8b7d-4458-ab2f-0e46b3b5beb4
   :END:
- General approach seems to be to make the chapters presentations of
  different studies (papers/proceedings) and the subsequent results
  and conclusions that can be made.
- Chuck said to use this as this is enabling the trajectory work
** Introduction
   :PROPERTIES:
   :ID:       8736adf3-2606-43c1-ba5d-d3f92a74f9f8
   :END:
** Methods
   :PROPERTIES:
   :ID:       f9ebfd7f-108b-4dd3-a24c-dab617ab99dd
   :END:

** Results
   :PROPERTIES:
   :ID:       04615b7c-c67c-499c-b2f9-d236ff743ea4
   :END:

** Conclusion
   :PROPERTIES:
   :ID:       0b2ab8ae-fd94-4d01-a7e0-8bef4db30078
   :END:
* Geometric calibration
  :PROPERTIES:
  :ID:       652970b8-4916-4190-b83b-2d6ae117c8b3
  :END:
** notes                                     :noexport:
   :PROPERTIES:
   :ID:       5c9cdd8b-721f-49b3-b136-c3282bf3659c
   :END:
- General approach seems to be to make the chapters presentations of
  different studies (papers/proceedings) and the subsequent results
  and conclusions that can be made.
** Introduction
   :PROPERTIES:
   :ID:       26feb0f0-f33e-4972-af9c-f73e0124f074
   :END:
Correctly modeling the geometric parameters of the image acquisition
is a critical tomographic image reconstruction. This is true
regardless of whether reconstruction is done with analytic-based or
optimization-based methods. Any inconsistency between the real
projection geometry and that used for image reconstruction will appear
as artifacts in the reconstructed image.

While investigating different non-standard scanning trajectories, we
found that correct geometric calibration must be performed to avoid
geometric imaging artifacts. As with the optimization-based image
reconstruction, we needed a calibration procedure that would provide a
robust calibration protocol for the different scanning configurations
we wanted to scan. This is especially true when working with
trajectories where the object is moving in addition to the source and
detector during the scan.

Previous work on geometric calibration for tomographic image
reconstruction has approached the calibration problem via analytic
cite:noo_analytic_2000,smekal_geometric_2004,cho_accurate_2005,yang_geometric_2006,daly_geometric_2008
and estimation
cite:gullberg_estimation_1990,rougee_geometrical_1993,mitschke_optimal_2000,silver_determination_2000,panetta_optimization-based_2008
frameworks. As with CT, the initial calibration efforts utilized
optimization-based methods to determine the geometric offsets from
projections of a known phantom geometry and nominal system setup. By
framing the calibration as an optimization problem, the acquisition
parameters were estimated in a way that minimized a cost function
associated with improper modeling of the acquisition geometry.

These calibration methods (analytic-based methods included) usually
rely on a known calibration phantom. This is typically a set of highly
attenuating fiducials arranged in a specific pattern. After scanning
the phantom with the system of interest, the detected fiducials are
then compared to the known geometry of the phantom. In the
analytic-based approach, the offsets are determined by solving for
parameters that would transform the projection of the phantom to match
the observed projection. In the optimization-based approach, geometric
parameters are varied to improve the match between the projection of
the modeled fiducials an the detected fiducials in the sinogram.

Both methods of performing geometric calibration have their own
strengths and weaknesses. The biggest advantage of utilizing
analytic-based calibration methods is that the sensitivity to
initialization and the sensitivity to the order of parameter variation
due to nonlinearity and coupling of parameters faced by estimation are
avoided cite:smekal_geometric_2004. However, as with
optimization-based reconstruction, optimization-based calibration
methods are more flexible in providing calibration offsets for the
novel trajectories that we studied.

Using previous work for optimization-based geometric calibration
cite:rougee_geometrical_1993,gullberg_estimation_1990,silver_determination_2000,
we developed a calibration method that utilizes a phantom with known
placement of highly attenuating fiducials. By scanning this phantom
and comparing the the projections to the modeled forward-projection of
a mathematical model of the phantom, we can more accurately determine
the system matrix $(\mathcal{H})$ in Equation ([[ref:eq:ddsys]]) for
reconstructing from a non-circular scanning trajectory with
optimization-based methods.

** Methods
   :PROPERTIES:
   :ID:       0b636fe5-fe45-4f10-a5fc-2de8a82bfbe4
   :END:
Where analytic-based methods, such as FDK, require a certain
acquisition trajectory such a as a fixed scanning radius of the source
and detector and the angular position of each projection, the
optimization-based system matrix makes no assumptions of the geometry
in other views. As such, we created a framework that incorporates the
best geometric estimate of the projection geometry of each view. The
flexibility to incorporate geometric corrections in this way is
another useful aspect in using optimization-based methods for image
reconstruction.

Before attempting to determine any geometric errors in our scanning
acquisition, we first modified the calculation of our system matrix to
incorporate the geometry information provided by the TrueBeam system.
In doing this, we took advantage of all the existing calibration
information that is provided with the current clinical system. Any
additional calibration information we could extract in addition to
this would then be the result of imaging with scanning configurations
that are not currently in clinical use.
*** Phantoms
    :PROPERTIES:
    :ID:       F5BECB45-8652-47A3-915C-1E96DA6110E7
    :END:
Our first calibration phantom for determining geometric offsets is
shown in Figure (\ref{fig:geocal}). The phantom is a 15.2 cm outer
diameter acrylic tube with a spiral pattern of CT-spot fiducials
placed 2.5 cm apart every $45^{\circ}$. When scanned, the CT spots are
clearly visible in the projection images which is ideal for automating
the fiducial detection in the data domain.

However, we realized that using such a spiral calibration phantom
creates a degree of ambiguity in the geometry of the projected
fiducials. With both this phantom and additional calibration phantoms
we created, too much symmetry in the phantom design leads to a rather
challenging objective function. To avoid such complexity, a
calibration phantom with intentional asymmetry is desirable.

In addition to the necessary complexity created by this phantom,
another concern for a calibration phantom is the uncertainty in the
geometry of the phantom itself. Though the guide lines on the cylinder
were inscribed with the lathe and its rotational stage, we placed the
fiducials by hand. As we were trying to determine millimeter offsets
with our calibration, this fiducial placement was suboptimal.

#+CAPTION: Initial geometric calibration phantom with a spiral fiducial pattern.
#+ATTR_LaTeX: scale=0.75
#+LABEL: fig:geocal
[[../../research/trajectories/geometry/geocal/20140901_extended_cllc.jpg]]

The phantom we then decided to use for calibration was the Isocal
phantom created by Varian shown in Figure ([[ref:fig:isocal]]). The Isocal
phantom directly addresses the two problems encountered with our first
phantom. First, the phantom is designed with intentional asymmetry.
Additionally, the phantom is manufactured by Varian to help align the
MV-treatment isocenter with the kV-imaging isocenter. As such, the
position of the beads on this phantom have a much tighter tolerance
than that of our original phantom.

#+CAPTION: Varian's Isocal phantom positioned at the isocenter.
#+ATTR_LaTeX: scale=0.75
#+LABEL: fig:isocal
[[../../research/phantoms/isocal/imgs/161012_isocal.jpg]]

*** Calibration Method
    :PROPERTIES:
    :ID:       F53F4B5A-83EB-4B16-9B6D-F557D3E441C2
    :END:
We designed a calibration procedure specifically for the non-standard
scanning trajectories we implemented on the TrueBeam system with
Developer Mode. As such, the nominal trajectory used to initialize our
calibration method was with the view-by-view geometry information
provided by the system for each projection. As this was the
uncalibrated initial guess with which we calculated our reconstruction
system matrix $\mathcal{H}$, the output of the calibration
subsequently improved the system matrix we used for image
reconstruction.

As with other calibration procedures, we allowed incremental variation
in the different geometric parameters of our scanning trajectory to
find the offsets that improve the match between the scan (observed
projections) of our calibration phantom with a trajectory of interest,
and the simulated projection of our phantom model with that geometry.
Assuming the accuracy of the modeled phantom fiducials (an assumption
that motivated our switch to the tighter tolerances of Varian's Isocal
phantom), the phantom pose (position and orientation) is first allowed
to vary in the room coordinate system to account for potential setup
errors between the room coordinates and the modeled position of the
phantom. As the geometry information reported by the TrueBeam system
is in this coordinate system, it is necessary to ensure that the
specified offsets are pertinent to calculating the system matrix.

For a new trajectory, this phantom is first scanned to identify any
geometric offsets that are incorrectly reported in the TrueBeam data
headers. Though we found the self-reported position accuracy from the
acquisition metadata to be very good, there were still some scanning
configurations for which we found the additional refinement from our
geometric calibration to be critical for obtaining a useful
reconstruction. This was particularly true for scanning trajectories
where the object and the kV imaging system were moving simultaneously.

Starting with the nominal scanning geometry from the projection
metadata, we first build an initial projection matrix
$(X_{\text{projmat}})$ that transforms the simulated phantom fiducials in
room coordinates to projected spots in detector coordinates.

# #+CAPTION: Schematic representation of the scanning geometry
# #+ATTR_LaTeX: :width 0.75\textwidth
# #+LABEL: fig:scan_geo
# [[file:figures/system_geometry.pdf]]

#+LABEL: fig:scan_geo
#+BEGIN_SRC asymptote :file figures/geo/system_geo.pdf :exports results
settings.render = 0;
import three;
size(100);
path3 g=(1,0,0)..(0,1,0)..(-1,0,0)..(0,-1,0)..cycle;
draw(g);
draw(O--Z,red+dashed,Arrow3);
draw(((-1,-1,0)--(1,-1,0)--(1,1,0)--(-1,1,0)--cycle));
#+END_SRC

#+CAPTION: Schematic representation of the scanning geometry
#+ATTR_LaTeX: :width 0.75\textwidth
#+RESULTS: fig:scan_geo
[[file:figures/geo/system_geo.pdf]]

#+begin_src asymptote :file figures/asymptote.pdf :exports none
settings.render = 0;
import three;

size(560,320,IgnoreAspect);
size3(140,80,15);
currentprojection=perspective(-2,20,10,up=Y);
currentlight=White;

real a=-0.4;
real b=0.95;
real y1=-5;
real y2=-3y1/2;
path A=(a,0){dir(10)}::{dir(89.5)}(0,y2);
path B=(0,y1){dir(88.3)}::{dir(20)}(b,0);
real c=0.5*a;
pair z=(0,2.5);
transform t=scale(1,15);
transform T=inverse(scale(t.yy,t.xx));
path[] g=shift(0,1.979)*scale(0.01)*t*
  texpath(Label("{\it symptote}",z,0.25*E+0.169S,fontsize(24pt)));
pair w=(0,1.7);
pair u=intersectionpoint(A,w-1--w);

real h=0.25*linewidth();
real hy=(T*(h,h)).x;
g.push(t*((a,hy)--(b,hy)..(b+hy,0)..(b,-hy)--(a,-hy)..(a-hy,0)..cycle));
g.push(T*((h,y1)--(h,y2)..(0,y2+h)..(-h,y2)--(-h,y1)..(0,y1-h)..cycle));
g.push(shift(0,w.y)*t*((u.x,hy)--(w.x,hy)..(w.x+hy,0)..(w.x,-hy)--(u.x,-hy)..(u.x-hy,0)..cycle));
real f=0.75;
g.push(point(A,0)--shift(-f*hy,f*h)*A--point(A,1)--shift(f*hy,-f*h)*reverse(A)--cycle);
g.push(point(B,0)--shift(f*hy,-f*h)*B--point(B,1)--shift(-f*hy,f*h)*reverse(B)--cycle);

triple H=-0.1Z;
material m=material(lightgray,shininess=1.0);

for(path p : g)
  draw(extrude(p,H),m);

surface s=surface(g);
draw(s,red,nolight);
draw(shift(H)*s,m);
#+end_src

These projected spots are then matched to the detector spots in the
sinogram. The $L_2$ norm between the real and simulated projected spots
is then calculated as the cost function. The parameters corresponding
to the geometric degrees of freedom (DOF) are then allowed to
iteratively vary by using the Nelder-Mead simplex algorithm
cite:lagarias_convergence_1998 to search for the geometric offsets
that minimize the $L_{2}\text{-norm}$ cost function. Once the cost has
been minimized, the geometric offsets are used as the calibration
information for calculating the system matrix $(\mathcal{H})$ for the
image reconstruction.

Given that there are there are different combinations of couch, source
and detector motions that can cause the same change of the object
relative to the source and detector within the image coordinate
system, there are some degrees of freedom that can couple with others.
For instance, shifting the patient in the positive longitudinal
direction if effectively the same as allowing the source and detector
to move the same distance in the negative longitudinal direction. This
requires that only a few parameters are allowed to vary at once as
allowing too many parameters on this non-convex surface will often
produce nonphysical geometric corrections.
*** geocal procedure                         :noexport:
    :PROPERTIES:
    :ID:       DD6F1968-D9A8-46AB-AC2C-BF79512B530A
    :END:
The current version of the geocal procedure uses a single step
projection matrix to transform positions in room coordinates to pixels
on the detector. do you want to incude the equation for that? this is
it basically, where “framevecs” are the 3 detector basis vectors
rotated by roll, pitch, yaw and then gantry angle - your usual frame
vectors. also note that my htransform_vectors function premultiplies
the matrix by the vector, i.e. X’ = X M, so the component
transformations are applied from left to right - if M=ABC, then it’s A
first followed by B followed by C.

#+BEGIN_SRC matlab
grotvecs=framevecs;
dnormrot=grotvecs(3,:);

sourcedetray=rotdet-rotsrc;  % this can be any ray connecting the source
                             % with a point on the detector

along=dot(sourcedetray,dnormrot);  % this is the new L for projection.
                                   % the "along" component is the same for
                                   % every ray from source to detector

% find the new piercing point, of ray through source along det normal
% direction.
newpierce=rotsrc+along*dnormrot;
mygmat=eye(4,4);
mygmat(1:3,1:3)=grotvecs';
mygtmat=hmatrix_translate(-rotsrc)*mygmat;

projmat=eye(4,4);
projmat(4,4)=0;
projmat(3,4)=1.0/along;
% compress the above to a single step - transform to detector basis,
% project
magicmat=mygtmat*projmat;

% to compute pixel coordinates, first find the U and V coordinates of the
% piercing point.  then just add the fids_on_detector U and V values.
% note these will still be in cm, not in pixels.  last thing will be to
% scale by pixel size and add detector center position, e.g. (512,384).
pierceoffset=newpierce-rotdet;
uvpierce=htransform_vectors(mygmat,pierceoffset);

%uvfids1=(fids_on_det_4(:,1:2)+repmat(uvpierce(1:2),size(fids_on_det_4,1),1))/pixsize;
xprojmat=magicmat*hmatrix_translate(uvpierce)* ...
         hmatrix_scale([1.0/pixsize 1.0/pixsize 1])* ...
         hmatrix_translate([usize/2+0.5, vsize/2+0.5, 0]);

#+END_SRC
*** Experimental Validation
Once we had a calibration

*** Image entropy                            :noexport:
    :PROPERTIES:
    :ID:       2410E321-8750-473F-B6B6-13DC1719B6AE
    :END:
To further verify the effectiveness of the calibration procedure, we
will also need to use additional metrics to quantitatively
characterize the impact of using the calibration on image quality. The
work of Wicklein et al. has suggested that the best metric for
measuring the impact of geometric error on image quality is entropy
$(E)$ of the image's gray-level histogram $(H)$. This is defined as
#+BEGIN_EXPORT latex
\begin{equation}
\label{eq:entropy}
E=-\sum_{q=0}^Q h(q)\cdot\text{log}(h(q))
\end{equation}
#+END_EXPORT
where $Q$ is the maximum intensity value and
#+BEGIN_EXPORT latex
\begin{equation}
\label{eq:norm_hist}
h(q)=\frac{H(q)}{N}
\end{equation}
#+END_EXPORT
is the normalized histogram cite:wicklein_image_2012. For this metric,
minimum entropy is obtained for an image with a single intensity value
while an image with uniform distribution over all intensity values
would have maximum entropy.

Geometric errors introduce blurring at sharp boundaries in the image
which increases the entropy. By reducing geometric errors with
calibration, this blurring effect and subsequently entropy should
reduced. For our non-circular trajectories, Wicklein's conclusion can
be verified readily with the images in our catalog of geometric
errors. The image entropy of the correct-geometry reconstruction will
be against the reconstructions with intentional geometric errors to
determine if improved geometric modeling reduces the image entropy in
Equation (\ref{eq:entropy}).

If the entropy calculations based on simulation agree with Wicklein's
findings, entropy would be reasonable metric to characterize the
benefits and limitations of using the geometric offsets from the
calibration phantom on different non-circular trajectory
reconstructions. We would then use entropy as the metric to compare
reconstructions with and without calibration. From this, we can not
only verify the effectiveness of our calibration method with different
non-circular trajectories, but also then characterize the impact
additional geometric corrections have on image quality.

*** Geometric-offset artifact catalog        :noexport:
Though the type of artifacts that are introduced by geometric offsets
for circular scanning trajectories are relatively well known, this
same sort of understanding is lacking for these new trajectories. To
study how geometric offsets affect images reconstructed from these new
trajectories, we will create a simulation catalog of artifacts
produced by different geometric errors. By introducing intentional
geometric inconsistencies in the reconstruction system matrix, we can
characterize the artifacts that appear in the reconstruction compared
to a numerically-exact inverse crime reconstruction.

As one of our primary objectives in using these novel trajectories is
to create an extended axial FOV image, we need to study how these
geometric errors degrade the image quality along the axial
direction. To ensure our simulation can adequately identify these
artifacts, we will create a simulated phantom such as an axially
extended version of the Catphan high resolution module. This will
provide resolution metrics not only in the axial dimension, but also
in the transverse planes as a function of axial position.

The simulation catalog of different artifacts that arise from
geometric offsets will provide a guide to visually identify potential
geometric errors based on the reconstructed image. This provide one
way in which we can verify the effectiveness of our geometric
calibration procedure. By incorporating the calibration information we
obtain with the calibration, known geometric error artifacts should be
reduced.

*** ideas                                    :noexport:
Given that part of the robust nature of optimization-based algorithms
is the ability to handle the poorly-conditioned nature of the inverse
problem...

*** figures                                  :noexport:
**** geometry
     :PROPERTIES:
     :ID:       ABFDF4A1-18BE-475C-8044-CFA1D0D63732
     :END:
***** [[file:figures/geo/coords.asy][coords]]
** Results
   :PROPERTIES:
   :ID:       bc50c80a-fbb7-41d3-a9d0-ebc552f59896
   :END:
** Conclusion
   :PROPERTIES:
   :ID:       80e42b2c-5d4b-4646-91df-753802591344
   :END:
* Axial field-of-view extension
  :PROPERTIES:
  :ID:       eaae199f-f899-4862-af50-720895a31c36
  :END:
** notes                                     :noexport:
   :PROPERTIES:
   :ID:       7c250434-fff6-41a3-aea3-e7bc9ff88dc6
   :END:
- General approach seems to be to make the chapters presentations of
  different studies (papers/proceedings) and the subsequent results
  and conclusions that can be made.
*** publications
    :PROPERTIES:
    :ID:       48459222-20e7-43e5-9863-5022a5803a1b
    :END:
**** cite:davis_extended_2013
     :PROPERTIES:
     :ID:       5b4c7bca-d59b-4f33-8151-a6b359071249
     :END:
- simulation study of axial FOV extension
**** cite:davis_verifying_2013
     :PROPERTIES:
     :ID:       d4c20a7d-4982-4318-b591-9ff84ee809f5
     :END:
- Trilogy scans of RANDO and Defrise phantom for axial FOV extension
**** cite:pearson_investigation_2013
     :PROPERTIES:
     :ID:       6ae09b4c-d1d3-4705-b110-8a4a0e1f33dd
     :END:
- Similar results to [[id:d4c20a7d-4982-4318-b591-9ff84ee809f5][cite:davis_verifying_2013]] using RANDO and Defrise
  Trilogy scans
**** cite:davis_we-g-brf-07:_2014
     :PROPERTIES:
     :ID:       3f9687ce-f913-43a0-8e96-0ace96d7f67c
     :END:
- AAPM talk using CLLC scan from TrueBeam
**** cite:davis_su-e-i-02:_2015
     :PROPERTIES:
     :ID:       15f62bff-3fae-4083-b4b1-ad0594d25121
     :END:
- AAPM poster for disk phantom metrics
**** cite:davis_non-circular_2015
     :PROPERTIES:
     :ID:       cee07d24-100a-4c78-a42d-59cd707cda3b
     :END:
- Varian meeting showing non-circular scans
** Introduction
   :PROPERTIES:
   :ID:       b815fcd4-92c6-4f72-9905-10acc22b580e
   :END:

** Methods
   :PROPERTIES:
   :ID:       b42e5e65-dfda-4692-8ea6-f6d96bc1dd5b
   :END:
*** Simulation
    Clinical extended-axial-FOV images are obtained by stitching
    together two circular scans at different axial locations. We first
    wanted to find the maximum axial coverage that can be achieved with
    such a trajectory. That is, what would be the maximum axial
    spacing between the two planes of the source's trajectory for
    which a useful extended volume image could be reconstructed?

    Simulating forward projections from this trajectory, we compared
    the images obtained from stitching together the independent FDK
    images to those obtained by reconstructing the two circles as a
    single trajectory with MLEM. We also compared stacked FDK images
    to reconstructions from the simulated *CLC* and smooth
    trajectories.

    We simulated a Defrise-style phantom modeled with the 3D X-ray
    projection software TAKE cite:seger_matlab/c_2005. The phantom was
    composed of a 15.2 cm outer diameter acrylic cylinder with
    alternating density disks of Delrin and cork 0.5 mm thick. This
    particular phantom with alternating density disks is acknowledged
    by the authors of FDK as being particularly susceptible to
    cone-angle artifacts cite:feldkamp_practical_1984.

    We used the TAKE software to forward project the phantom as well
    as generate a digitized "truth" phantom for calculating comparison
    metrics. The projector generates a forward projection from a
    specified trajectory given a mathematical definition of the
    phantom as well as its material properties and the spectrum
    generated by the x-ray source.

    We created projection data for a set of dual-circle trajectories
    that had an increasing amount of axial separation between the two
    circles. With a 1.5x magnification factor and a 30 cm detector
    size along the axial direction, a single circular scan has a
    maximum axial coverage of 20 cm in the image space. Furthermore,
    the maximum spacing between the two circles is 20 cm as any
    separation larger than this means the independent image volumes
    from the two circles are no longer contiguous. We therefore
    created trajectories with 10, 12, 14, 16, 18, and 20 cm
    separations *only show the larger gaps that are of interest?*
    between the planes of the source's dual-circle trajectory.

    We uniformly distributed 600 views over the entire trajectory
    which is comparable to the total number of views used in a single
    clinical CBCT scan with the kV imaging system. For the other two
    trajectories with a component of projection views taken during the
    axial translation (CLC and smooth), 600 views were used with 20% of
    the views being distributed along the axial translation stage.

    *FIX*

    The reconstruction image space consisted of a $256\times256$ transverse
    grid of 1 mm isotropic voxels. As the spacing between the circles
    increased, the number of voxels in the axial direction also
    increased to accommodate the increasingly large FOV.

    For the extended-volume reconstruction using the stacked FDK, we
    independently reconstructed each circular scan with FDK using a
    standard Hann filter. To combine the two reconstructed volumes for an
    extended axial-coverage image at a given spacing, we used the midplane
    between the two planes of the source's circular trajectory to select
    how much of each reconstruction to put in the combined image.

    For the MLEM reconstructions, we used all of the projection data
    simultaneously to reconstruct the extended volume. After defining the
    extended image volume, we computed the system matrix for each of the
    different spacings and trajectories based on the trajectory of the
    source and detector. We used 100 iterations *justify choice* of the
    MLEM algorithm to find an estimate for the image.


    *FIX*

    Our initial evaluation of the images obtained from non-circular
    trajectories is simply a qualitative visual inspection which does
    provide an informative assessment of the variety of artifacts that
    occur for a given reconstruction. For a more rigorous evaluation of
    the images obtained from different trajectories, we will use mutual
    information (MI) cite:pluim_mutual-information-based_2003 and the
    universal quality index (UQI) cite:wang_universal_2002 to provide a
    quantitative assessment of the image similarity between the reference
    image and the images from different trajectories.

*** Old FOV Paper Simulation
   :PROPERTIES:
   :ID:       6888683a-4d00-4cb2-be7e-8ac554af7595
   :END:
Since extended axial images in the clinic are obtained with two
circular scans at different axial locations, we wanted to find the
maximum axial coverage allowed by this dual-circle trajectory. That
is, what would be the maximum axial spacing between the two planes of
the source's trajectory for which a useful extended volume image could
be reconstructed? Using simulated forward projections from this
trajectory, we compared the images obtained from stacking the
independent FDK images to those obtained by reconstructing the two
circles as a single trajectory with MLEM. We also compared stacked FDK
images to reconstructions from the simulated CLC and smooth
trajectories.

**** Phantom
    :PROPERTIES:
    :ID:       bd73b61b-002b-481a-8b3a-712f1f2f1743
    :END:
The simulated phantom was a Defrise-style phantom modeled with the 3D
X-ray projection software TAKE cite:seger_matlab/c_2005. The phantom
was composed of a 15.2 cm outer diameter acrylic cylinder with
alternating density disks of Delrin and cork 0.5 mm thick. This
particular phantom with alternating density disks is acknowledged by
the authors of FDK as being particularly susceptible to cone-angle
artifacts cite:feldkamp_practical_1984.

**** Forward projection
    :PROPERTIES:
    :ID:       17f947de-c9f5-4313-ad70-3b77ff7ca929
    :END:
- [ ] Verify that the new version with the tested polychromatic
  behavior produces sinograms that are comparable to the ones we used
  in the initial study.

The forward projections of the phantom were acquired from the TAKE
software. The projector generates a forward projection from a
specified trajectory given a mathematical definition of the phantom as
well as its material properties and the spectrum generated by the
x-ray source. A digitized truth of the phantom was rendered by the
software to match the image space of the reconstruction for
calculating comparison metrics.

**** Trajectories
    :PROPERTIES:
    :ID:       5d84bea3-21b6-4311-a7de-ee73a956a152
    :END:
Given the 1.5 magnification factor and the 30 cm detector size along
the axial direction, a single circular scan has a maximum axial
coverage of 20 cm in the image space. Furthermore, the maximum spacing
between the two circles is 20 cm as any separation larger than this
means the independent image volumes from the two circles are no longer
contiguous. We therefore created trajectories with 10, 12, 14, 16, 18,
and 20 cm separations *only show the larger gaps that are of
interest?* between the planes of the source's dual-circle trajectory.

We created projection data for a set of dual-circle trajectories that
had an increasing amount of axial separation between the two
circles. We uniformly distributed 600 views over the entire trajectory
which is comparable to the total number of views used in a single
clinical CBCT scan with the kV imaging system. For the other two
trajectories with a component of projection views taken during the
axial translation (CLC and smooth), 600 views were used with 20% of
the views being distributed along the axial translation stage.

***** TAKE check
:PROPERTIES:
:ID:       2bacd921-aa76-4225-9992-4b8f5b1f3198
:END:
- [ ] Verify new projection data matches old sinograms.
- [ ] Verify the number of views that compose the trajectory.
- [ ] If all of the projection information matches, use the
  reconstructions I presented in my proposal.

**** Reconstruction
    :PROPERTIES:
    :ID:       1c0fa74f-e955-492e-a1d4-bfb81cd21cbf
    :END:
The reconstruction image space consisted of a $256\times256$ transverse
grid of 1 mm isotropic voxels. As the spacing between the circles
increased, the number of voxels in the axial direction also increased
to accommodate the increasingly large FOV.

For the extended-volume reconstruction using the stacked FDK, we
independently reconstructed each circular scan with FDK using a
standard Hann filter. To combine the two reconstructed volumes for an
extended axial-coverage image at a given spacing, we used the midplane
between the two planes of the source's circular trajectory to select
how much of each reconstruction to put in the combined image.

For the MLEM reconstructions, we used all of the projection data
simultaneously to reconstruct the extended volume. After defining the
extended image volume, we computed the system matrix for each of the
different spacings and trajectories based on the trajectory of the
source and detector. We used 100 iterations *justify choice* of the
MLEM algorithm to find an estimate for the image.

**** Evaluation
:PROPERTIES:
:ID:       7b8e3df7-2509-4e65-8e5a-9b5a468322d8
:END:
Our initial evaluation of the images obtained from non-circular
trajectories is simply a qualitative visual inspection which does
provide an informative assessment of the variety of artifacts that
occur for a given reconstruction. For a more rigorous evaluation of
the images obtained from different trajectories, we will use mutual
information (MI) cite:pluim_mutual-information-based_2003 and the
universal quality index (UQI) cite:wang_universal_2002 to provide a
quantitative assessment of the image similarity between the reference
image and the images from different trajectories.

** Results
   :PROPERTIES:
   :ID:       b2a353e8-8531-4a0e-8337-9f702ecf02f8
   :END:

*** Simulation
:PROPERTIES:
:ID:       ff434d74-757c-47b8-bd98-9250d2751ff2
:END:


The initial simulation results demonstrated promising advantages to
using the optimization-based reconstruction to produce extended-axial
coverage images.

- [ ] insert comparison table of FDK
- [ ] show plot of RMSE in the overlap region

From the results shown in Figure (\ref{fig:})

** Conclusion
   :PROPERTIES:
   :ID:       99a861bc-c072-4082-806f-9279fa7c3a3c
   :END:
* Collision-avoiding trajectories
  :PROPERTIES:
  :ID:       99055e18-4b61-404e-9408-ebd5fd0a5d8d
  :END:
** notes                                     :noexport:
   :PROPERTIES:
   :ID:       53a46fd0-a854-4b6a-a253-dde04d4f7a87
   :END:
- General approach seems to be to make the chapters presentations of
  different studies (papers/proceedings) and the subsequent results
  and conclusions that can be made.
*** publications
    :PROPERTIES:
    :ID:       32703eae-6f65-4a6a-9f23-813e60747126
    :END:
- 2015 MIC virtual isocenter
- 2016 CT meeting dyanmic magnification
- 2016 MIC mixed magnification
- 2017 Varian dynamic magnification
** Introduction
   :PROPERTIES:
   :ID:       d5a22c7a-f72e-4a1c-b90f-69f7084d42e1
   :END:
The addition of a linac-mounted, kV-imaging, cone-beam computed
tomography (CBCT) system to the gantry-mounted clinical linear
accelerator (linac) helped this modality become the most popular form
of image-guided radiation therapy (IGRT)
cite:rahman_linac:_2015,jaffray_flat-panel_2002-1,letourneau_cone-beam-ct_2005.
The tomographic information provided in the kV energy range improves
soft-tissue contrast resolution over that provided by the MV
electronic portal imaging device (EPID) alone
cite:jaffray_radiographic_1999. The linac-mounted, kV-imaging, CBCT
system not only helps with patient setup and target verification, but
it also allows the monitoring of the tumor response during treatment
cite:dawson_advances_2007.

There is therefore a loss in clinical utility when it is not possible
to obtain tomographic information from the kV-imaging CBCT system. One
situation in which this can occur is when a collision between the
patient and the gantry arises cite:padilla_collision_2015. These may
be of particular concern in breast and lung cancer patients where the
arm positions leads to a possible collision as shown in Figure ([[ref:fig:barbie_collision][barbie
collision]]). Collisions also present a problem in treatment of
posterior and lateral lesions in stereotactic body radiosurgery
(SBRT). Similarly in prone breast treatments, where the target is near
the couch top and a lateral couch translation is needed to bring the
target to isocenter, collision with the contralateral side of the
patient may occur. When collisions do occur, the angular range
available for scanning is restricted and it is not possible to acquire
complete projection data.

#+CAPTION: Example of a typical patient-gantry collision. The patient's arms for this treatment position can often collide with the MV-treatment head.
#+ATTR_LaTeX: :width \columnwidth :placement [t]
#+LABEL: fig:barbie_collision
[[./figures/collisions/barbie.jpg]]

The analytic-based FDK reconstruction algorithm, still the clinical
workhorse for CT reconstruction, imposes certain requirements on the
acquisition trajectory cite:feldkamp_practical_1984,pan_why_2009.
Specifically, the inverse problem is derived from a circular scanning
trajectory, and such a trajectory must be acquired to meet the data
sufficiency conditions. A potential patient-gantry collision
restricting the angular coverage could prevent sufficient projection
data from being acquired.

Though there has been previous work in developing analytic methods for
addressing the inverse problem from some novel trajectories
cite:katsevich_image_2004,katsevich_theoretically_2002,katsevich_image_2005,katsevich_formulation_2006,
it could be clinically useful to enable reconstruction from an
arbitrary, collision-avoiding trajectory. As the collision region (if
one arises) is contingent on the patient's treatment position, the
imaging trajectory would then vary on a per patient basis. As such,
deriving the analytic inverse for each patient's scanning trajectory
would be impractical in a clinical work flow.

Advances in optimization-based reconstruction algorithms provide a
potential means of enabling reconstruction from patient-specific
collision avoiding trajectories
cite:bian_optimization-based_2013,han_optimization-based_2012. The
imaging model is formulated as the linear transform
#+BEGIN_EXPORT latex
\begin{equation}
  \label{eq:linmodel}
  \mathbf{g}=\mathcal{H}\mathbf{f},
\end{equation}
#+END_EXPORT
where $\mathbf{g}$ is the discrete $M$ pixel sampled projection on the
detector, $\mathcal{H}$ is the $M\times N$ discrete form of the X-ray
transform, and $\mathbf{f}$ is the object function represented on a N
voxel basis. As the direct inversion of Equation ([[ref:eq:linmodel][linear model]]) is
impractical due to both its size and inconsistencies from factors such
as noise, optimization techniques are used to solve this system for an
estimate of the object $\widetilde{\mathbf{f}}$.

These optimization-based methods impose no restrictions on the
trajectory of the acquired views. Provided the geometry of each view
is correctly incorporated into the system matrix $\mathcal{H}$, these
robust algorithms can provide clinically useful reconstructions from
acquisitions that fail to meet the stipulated data conditions assumed
in the formulation of an analytic inverse.

In this study, we investigate examples of potential scanning
trajectories that would allow the acquisition of sufficient projection
information for a clinically useful image while avoiding a potential
patient collision with the gantry. As the gantry rotates, there are
two components of the linac that are potential sources of patient
collisions. These are the MV-treatment head, shown in Figure ([[ref:fig:barbie_collision][barbie
collision]]), and the kV-CBCT detector.

One trajectory that would avoid a patient collision with the
MV-treatment head is a virtual isocenter trajectory. This trajectory
resolves such a collision by increasing the effective source-to-axis
distance (SAD). By using this increased SAD for an imaging trajectory,
the clearance between the patient and the MV-treatment head as the
gantry rotates is increased and the collision is avoided.

The virtual isocenter trajectory utilizes synchronized gantry rotation
and couch translation to maintain a fixed distance (``virtual SAD'')
between the MV source and a chosen center of rotation (``virtual
isocenter'') in the patient. At the beginning of the scan, the patient
is moved away from the linac head along the MV beam direction. As the
gantry rotates, the couch continuously moves away from the linac head
to maintain the specified separation as shown in Figure
([[ref:fig:virtual_iso]]). The virtual SAD can be chosen large enough so
that collisions as shown in Figure ([[ref:fig:barbie_collision]]) are
avoided; at this point in the trajectory, the couch would have moved
far enough to the left to avoid the collision.

#+BEGIN_EXPORT latex
\begin{figure*}[htb]
  \centering
  \includegraphics[width=0.9\textwidth]{figures/collisions/gantry_6angles_a.jpg}
  \caption{
    Patient, kV and MV beams and kV detector at several angles during a virtual isocenter rotation.  Room coordinate system (dotted axes) has its origin at mechanical isocenter, also the intersection of the MV (red) and kV (green) beam axes.  As the gantry rotates, the patient (filled contour) is continually shifted to maintain a specified distance along the MV beam direction between the mechanical isocenter and the chosen virtual isocenter (circle symbol within the patient).  The path of the virtual isocenter is a circle about the mechanical isocenter, with radius equal to the chosen shift (12 cm from the isocenter in this example).  Detector may or may not be shifted as shown, depending on virtual isocenter position and patient geometry.
    \label{fig:virtual_iso}}
\end{figure*}
#+END_EXPORT

Another trajectory that could avoid a patient collision with the kV
detector would be one during which either the patient of the detector
is moved during the scan in the angular range of a collision. Either
solution leads to dynamic magnification scan where the kV-CBCT imaging
magnification changes during the acquisition. Again,
optimization-based reconstruction methods can easily handle such a
change in magnification provided the projection information is
correctly incorporated into the system matrix.

Finally, we study a trajectory that combines both the virtual
isocenter and the dynamic magnification trajectories to create a
hybrid scanning acquisition that would alleviate collisions with both
the MV-treatment head and the kV-CBCT detector (note that it is only
the distance to the linac head that is increased in the plain virtual
SAD technique; the distance from the kV source and detector to the
patient and to each other are unchanged). We use such a trajectory as
an example of a patient-specific scanning trajectory designed to avoid
a particular collision that arises with a particular treatment
position.

** Methods
   :PROPERTIES:
   :ID:       9d2ba9ad-7739-46ab-9983-754fa6adac28
   :END:
*** Virtual isocenter trajectory
The virtual isocenter trajectory utilizes synchronized gantry rotation
and couch translation to maintain a fixed distance (``virtual SAD'')
between the MV source and a chosen center of rotation (``virtual
isocenter'') in the patient. At the beginning of the scan, the patient
is moved away from the linac head along the MV beam direction. As the
gantry rotates, the couch continuously moves away from the linac head
to maintain the specified separation as shown in Figure
([[ref:fig:virtual_iso]]).

*** Dynamic magnification trajectory

*** Moving toward generalized trajecotries
** Results
   :PROPERTIES:
   :ID:       a59ef4e0-4966-4c76-b283-5aea6b92360e
   :END:
*** Virtual isocenter trajectory
*** Dynamic magnification trajectory
*** Moving toward generalized trajecotries

** Conclusion
   :PROPERTIES:
   :ID:       8784656f-c169-410a-9a76-0454c6ab5dde
   :END:

* Summary and Conclusions
  :PROPERTIES:
  :ID:       1bade25b-80d6-4650-b8a3-baf370fa657c
  :END:

\makebibliography
